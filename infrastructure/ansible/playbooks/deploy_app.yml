---
- name: Pull images from ACR and deploy app in Azure VM
  hosts: app_vm
  become: yes

  vars:
    app_dir: /home/mattsellings/app
    acr_name: superguitartab

  tasks:
    - name: Ensure Docker is running
      systemd:
        name: docker
        state: started
        
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: mattsellings
        group: mattsellings
        mode: "0755"

    - name: Login to Azure using Managed Identity
      command: az login --identity
      register: az_login_result
      changed_when: false

    - name: Login to Azure Container Registry using Managed Identity
      command: az acr login --name "{{ acr_name }}"
      changed_when: false

    - name: Create .env.tabs-api file for tabs-api environment variables
      copy:
        dest: "{{ app_dir }}/.env.tabs-api"
        owner: mattsellings
        group: mattsellings
        mode: "0600"
        content: |
          APP_ENV=PRODUCTION

          DATABASE_NAME={{ database_name }}
          DATABASE_USER={{ database_user }}
          DATABASE_PASSWORD={{ database_password }}
          DATABASE_HOST={{ database_host }}

          ACCESS_SECRET_KEY={{ access_secret_key }}
          REFRESH_SECRET_KEY={{ refresh_secret_key }}
          SESSION_SECRET_KEY={{ session_secret_key }}

          DIGITAL_OCEAN_BUCKET_SECRET_KEY={{ digital_ocean_bucket_secret_key }}
          DIGITAL_OCEAN_BUCKET_ACCESS_KEY_ID={{ digital_ocean_bucket_access_key_id }}
          DIGITAL_OCEAN_BUCKET_NAME={{ digital_ocean_bucket_name }}
          DIGITAL_OCEAN_BUCKET_REGION_NAME={{ digital_ocean_bucket_region_name }}

          GOOGLE_CLIENT_SECRET={{ google_client_secret }}
          GOOGLE_CLIENT_ID={{ google_client_id }}
          GOOGLE_REDIRECT_URL={{ google_redirect_url }}

          REDIS_HOST={{ redis_host }}
          REDIS_PORT={{ redis_port }}
          REDIS_DB={{ redis_db }}

          BREVO_API_KEY={{ brevo_api_key }}
          FROM_EMAIL={{ from_email }}

    - name: Copy docker-compose file
      copy:
        src: "{{ playbook_dir }}/../../../compose/production/docker-compose.app.yml"
        dest: "{{ app_dir }}/docker-compose.yml"
        owner: mattsellings
        group: mattsellings
        mode: "0644"

    - name: Pull and start containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        pull: always
        state: present